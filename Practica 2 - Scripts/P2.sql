/**********************************************************************************
*
*                                    EJERCICIO 1
*
**********************************************************************************/
--1.
--@crear_tablas.sql;
select * from GIISGBD.ACTORES_DATOS2;
-- Resultado: 9.146 filas insertadas.

insert into actuacion 
select * from GIISGBD.ACTUACION_DATOS2;
-- Resultado: 12.500 filas insertadas.

insert into PELICULAS
select * from GIISGBD.PELICULAS_DATOS2;
-- Resultado: 11.182 filas insertadas.

--2.
CREATE INDEX IDX_SEXO
ON ACTORES (SEXO);
-- Index IDX_SEXO creado.
CREATE INDEX IDX_ANYO
ON PELICULAS (ANYO);
-- Index IDX_ANYO creado.

--3.
exec dbms_stats.gather_table_stats(ownname => 'GIISGBD101', tabname => 'ACTORES',cascade => TRUE, force => TRUE);
--Procedimiento PL/SQL terminado correctamente.

exec dbms_stats.gather_table_stats(ownname => 'GIISGBD101', tabname => 'ACTUACION',cascade => TRUE, force => TRUE);
-- Procedimiento PL/SQL terminado correctamente.

exec dbms_stats.gather_table_stats(ownname => 'GIISGBD101', tabname => 'PELICULAS',cascade => TRUE, force => TRUE);
--Procedimiento PL/SQL terminado correctamente.

---4.a Taules: nom, nombre de files, nombre de blocs, longitud mitjana dels registres
SELECT table_name,
       num_rows,
       blocks,
       avg_row_len
FROM user_tables
where table_name in ('ACTORES', 'PELICULAS', 'ACTUACION');
/*
TABLE_NAME     NUM_ROWS     BLOCKS    AVG_ROW_LEN
--------------------------------------------------
ACTORES        9146        244            108
ACTUACION     12500        244            111
PELICULAS     11182        370            210

*/

/*4.b Columnes: nom de taula i de columna, quantitat de valors diferents, valors mínim i 
màxim, nombre de nuls, longitud mitjana de la columna, histograma.*/
SELECT table_name,
        column_name,
        num_distinct,
        low_value,
        high_value,
        num_nulls,
        avg_col_len,
        histogram
FROM user_tab_col_statistics;
/*

TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
ACTORES                                                                                                                          SEXO                                                                                                                                        1 
4D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
4D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
         0           2 NONE           


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
ACTORES                                                                                                                          NOM                                                                                                                                      9146 
41616C746F2C20416E75202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
6C6120507565626C612C204E69C3B161206465202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
         0         101 NONE           


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
ACTORES                                                                                                                          OID                                                                                                                                      9146 
C3173202                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
C33B3C35                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
         0           5 NONE           


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
ACTUACION                                                                                                                        PAPEL                                                                                                                                    6585 
317374204174746F726E657920202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
C3897661202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
         0         101 NONE           


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
ACTUACION                                                                                                                        PELI                                                                                                                                    11182 
C3173108                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
C33B3B54                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
         0           5 NONE           


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
ACTUACION                                                                                                                        ACTOR                                                                                                                                    9146 
C3173202                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
C33B3C35                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
         0           5 NONE           


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
PELICULAS                                                                                                                        ANYO                                                                                                                                       95 
80                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
C21464                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
         0           4 FREQUENCY      


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
PELICULAS                                                                                                                        TITULO                                                                                                                                  11014 
2431303030206120546F756368646F776E2020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
C3BF72626F6C2064652045737061C3B1612C20456C20202020202020202020202020202020202020202020202020202020202020202020202020202020202020                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
         0         201 NONE           


TABLE_NAME                                                                                                                       COLUMN_NAME                                                                                                                      NUM_DISTINCT
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ------------
LOW_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
HIGH_VALUE
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 NUM_NULLS AVG_COL_LEN HISTOGRAM      
---------- ----------- ---------------
PELICULAS                                                                                                                        OID                                                                                                                                     11182 
C3173108                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
C33B3B54                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
         0           5 NONE           


9 filas seleccionadas. 


*/



/*4.c Índexs: nom, taula, profunditat, blocs en les fulles, quantitat de claus diferents, 
mitjana de blocs fulla per clau, mitjana de blocs de dades per clau, factor de 
clustering, nombre de registres
*/
SELECT index_name,
        table_name,
        blevel,
        leaf_blocks,
        distinct_keys,
        avg_leaf_blocks_per_key,
        avg_data_blocks_per_key,
        clustering_factor,
        num_rows
FROM user_indexes
where table_name in ('ACTORES','PELICULAS', 'ACTUACION');
/*

INDEX_NAME                                                                                                                       TABLE_NAME                                                                                                                           BLEVEL LEAF_BLOCKS DISTINCT_KEYS AVG_LEAF_BLOCKS_PER_KEY AVG_DATA_BLOCKS_PER_KEY CLUSTERING_FACTOR   NUM_ROWS
-------------------------------------------------------------------------------------------------------------------------------- -------------------------------------------------------------------------------------------------------------------------------- ---------- ----------- ------------- ----------------------- ----------------------- ----------------- ----------
SYS_C00377216                                                                                                                    ACTORES                                                                                                                                   1          18          9146                       1                       1               153       9146
IDX_SEXO                                                                                                                         ACTORES                                                                                                                                   1          17             1                      17                     143               143       9146
SYS_C00377224                                                                                                                    ACTUACION                                                                                                                                 1         190         12500                       1                       1               278      12500
SYS_C00377220                                                                                                                    PELICULAS                                                                                                                                 1          21         11182                       1                       1               443      11182
IDX_ANYO                                                                                                                         PELICULAS                                                                                                                                 1          24            95                       1                      88              8450      11182

*/

/*5.
   Los valores salen en hexadecimal, el histograma sale como NONE
*/

--6.
DROP INDEX IDX_SEXO;
--Index IDX_SEXO borrado.
DROP INDEX IDX_ANYO;
--Index IDX_ANYO borrado.
exec dbms_stats.delete_table_stats(ownname => 'GIISGBD101', tabname => 'ACTORES');
--Procedimiento PL/SQL terminado correctamente.
exec dbms_stats.delete_table_stats(ownname => 'GIISGBD101', tabname => 'ACTUACION');
--Procedimiento PL/SQL terminado correctamente.
exec dbms_stats.delete_table_stats(ownname => 'GIISGBD101', tabname => 'PELICULAS');
--Procedimiento PL/SQL terminado correctamente.

--7. Consultar de nou la informació estadística emmagatzemada
/*
    Observamos que ahora todos los valores salen como null
*/


/**********************************************************************************
*
*                                    EJERCICIO 2
*
**********************************************************************************/



-- 1.-Executar les consultes i anotar els registres recuperats i el temps d’execució. 
--CONSULTA 1:
SELECT *
   FROM PELICULAS
   WHERE ANYO > 1992;

   --2000 FILAS Y EN 1,958 Segundos

--CONSULTA 2:
SELECT *
FROM PELICULAS P, ACTUACION ACT
WHERE P.OID = ACT.PELI
AND ANYO > 1992;
   --2294 FILAS RECUPERADAS Y 2,689 Segundos

--CONSULTA 3: 
SELECT P.*
FROM ACTORES A, ACTUACION X, PELICULAS P
WHERE A.NOM = 'Loy, Myrna'
AND A.OID = X.ACTOR
AND P.OID = X.PELI;
   --11 FILAS Y 0,038 segundos


/*2. Obtenir per a cadascuna d'elles el seu pla d'execució.
    a. Existeix alguna contradicció entre els plans d'execució i els continguts de les taules?*/

EXPLAIN PLAN FOR
   SELECT *
   FROM PELICULAS
   WHERE ANYO > 1992;
    
SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));

/*
-------------------------------------------------------------------------------
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |           |  2126 |   473K|   102   (0)| 00:00:01 |
|*  1 |  TABLE ACCESS FULL| PELICULAS |  2126 |   473K|   102   (0)| 00:00:01 |
-------------------------------------------------------------------------------
Predicate Information (identified by operation id):
---------------------------------------------------
   1 - filter("ANYO">1992)
Note
-----
   - dynamic statistics used: dynamic sampling (level=2)
   - SQL plan baseline "SQL_PLAN_37ncmpadunta7d6672d41" used for this statement
*/
EXPLAIN PLAN FOR
SELECT *
FROM PELICULAS P, ACTUACION ACT
WHERE P.OID = ACT.PELI
AND ANYO > 1992;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));
    
/*
---------------------------------------------------------------------------------------
| Id  | Operation             | Name          | Rows  | Bytes | Cost (%CPU)| Time     |
---------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT      |               |  2771 |   963K|   170   (0)| 00:00:01 |
|*  1 |  HASH JOIN            |               |  2771 |   963K|   170   (0)| 00:00:01 |
|*  2 |   TABLE ACCESS FULL   | PELICULAS     |  2126 |   473K|   102   (0)| 00:00:01 |
|   3 |   INDEX FAST FULL SCAN| SYS_C00377276 | 14167 |  1770K|    68   (0)| 00:00:01 |
---------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - access("P"."OID"="ACT"."PELI")
   2 - filter("ANYO">1992)
 
Note
-----
   - dynamic statistics used: dynamic sampling (level=2)
   - SQL plan baseline "SQL_PLAN_5rbfp05f7uk3m7c4a039a" used for this statement
*/
EXPLAIN PLAN FOR
SELECT P.*
FROM ACTORES A, ACTUACION X, PELICULAS P
WHERE A.NOM = 'Loy, Myrna'
AND A.OID = X.ACTOR
AND P.OID = X.PELI;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));
    
/*
----------------------------------------------------------------------------------------------
| Id  | Operation                    | Name          | Rows  | Bytes | Cost (%CPU)| Time     |
----------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT             |               |     9 |  3321 |    80   (0)| 00:00:01 |
|   1 |  NESTED LOOPS                |               |     9 |  3321 |    80   (0)| 00:00:01 |
|   2 |   NESTED LOOPS               |               |     9 |  3321 |    80   (0)| 00:00:01 |
|   3 |    NESTED LOOPS              |               |     9 |  1269 |    71   (0)| 00:00:01 |
|*  4 |     TABLE ACCESS FULL        | ACTORES       |     3 |   345 |    68   (0)| 00:00:01 |
|*  5 |     INDEX RANGE SCAN         | SYS_C00377276 |     3 |    78 |     1   (0)| 00:00:01 |
|*  6 |    INDEX UNIQUE SCAN         | SYS_C00377272 |     1 |       |     0   (0)| 00:00:01 |
|   7 |   TABLE ACCESS BY INDEX ROWID| PELICULAS     |     1 |   228 |     1   (0)| 00:00:01 |
----------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   4 - filter("A"."NOM"='Loy, Myrna')
   5 - access("A"."OID"="X"."ACTOR")
   6 - access("P"."OID"="X"."PELI")
 
Note
-----
   - dynamic statistics used: dynamic sampling (level=2)
   - SQL plan baseline "SQL_PLAN_4z5x6suxn6hpc21f1959c" used for this statement
*/
    --Si, la suma de los tiempos del plan de ejecución no coincide con los tiempos transcurridos




/*3. Investiga el significat del missatge “Note - dynamic sampling used for this statement”.
    El mensaje ese aparece cuando en Oracle se ejecuta una consulta y no dispone de estadísticas
    suficientes sobre las tablas implicadas.
*/

-- 4. Crear estadístiques per a tots els objectes
    exec dbms_stats.gather_table_stats(ownname=>'GIISGBD104',tabname=>'ACTORES', cascade=>true,force=>true);
    --Procedimiento PL/SQL terminado correctamente.  Transcurrido: 00:00:00.268
    exec dbms_stats.gather_table_stats(ownname=>'GIISGBD104',tabname=>'ACTUACION', cascade=>true,force=>true);
    --Procedimiento PL/SQL terminado correctamente. Transcurrido: 00:00:00.253
    exec dbms_stats.gather_table_stats(ownname=>'GIISGBD104',tabname=>'PELICULAS', cascade=>true,force=>true);
    --Procedimiento PL/SQL terminado correctamente. Transcurrido: 00:00:00.111
    
-- 5. Tornar a obtenir el pla d'execució de cada consulta i comparar-los amb els anteriors. 
--1
EXPLAIN PLAN FOR
SELECT *
FROM PELICULAS
WHERE ANYO > 1992;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));
    
/*
Plan hash value: 2378278331
 
-------------------------------------------------------------------------------
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |           |  1999 |   409K|   102   (0)| 00:00:01 |
|*  1 |  TABLE ACCESS FULL| PELICULAS |  1999 |   409K|   102   (0)| 00:00:01 |
-------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter("ANYO">1992)
 
Note
-----
   - SQL plan baseline "SQL_PLAN_37ncmpadunta7d6672d41" used for this statement

Consulta 1: Hay menos filas 1999 antes habia 2232. Bytes es menor 409K antes 473.
El coste es el mismo. No aparece el mensaje anterior - dynamic sampling used for this statement
*/

EXPLAIN PLAN FOR
SELECT *
FROM PELICULAS P, ACTUACION ACT
WHERE P.OID = ACT.PELI
AND ANYO > 1992;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));
    
/*
Plan hash value: 3982339754
 
---------------------------------------------------------------------------------------
| Id  | Operation             | Name          | Rows  | Bytes | Cost (%CPU)| Time     |
---------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT      |               |  2235 |   700K|   155   (0)| 00:00:01 |
|*  1 |  HASH JOIN            |               |  2235 |   700K|   155   (0)| 00:00:01 |
|*  2 |   TABLE ACCESS FULL   | PELICULAS     |  1999 |   409K|   102   (0)| 00:00:01 |
|   3 |   INDEX FAST FULL SCAN| SYS_C00377276 | 12500 |  1354K|    53   (0)| 00:00:01 |
---------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - access("P"."OID"="ACT"."PELI")
   2 - filter("ANYO">1992)
 
Note
-----
   - SQL plan baseline "SQL_PLAN_5rbfp05f7uk3m7c4a039a" used for this statement
Consulta 2: Hay menos filas 2235 antes habia 2771. Bytes es menor 409K antes 473.
El coste disminuye de 170 a 155.
*/

EXPLAIN PLAN FOR
SELECT P.*
FROM ACTORES A, ACTUACION X, PELICULAS P
WHERE A.NOM = 'Loy, Myrna'
AND A.OID = X.ACTOR
AND P.OID = X.PELI;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));
    
/*
Plan hash value: 3447177501
 
----------------------------------------------------------------------------------------------
| Id  | Operation                    | Name          | Rows  | Bytes | Cost (%CPU)| Time     |
----------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT             |               |     1 |   326 |    70   (0)| 00:00:01 |
|   1 |  NESTED LOOPS                |               |     1 |   326 |    70   (0)| 00:00:01 |
|   2 |   NESTED LOOPS               |               |     1 |   326 |    70   (0)| 00:00:01 |
|   3 |    NESTED LOOPS              |               |     1 |   116 |    69   (0)| 00:00:01 |
|*  4 |     TABLE ACCESS FULL        | ACTORES       |     1 |   106 |    68   (0)| 00:00:01 |
|*  5 |     INDEX RANGE SCAN         | SYS_C00377276 |     1 |    10 |     1   (0)| 00:00:01 |
|*  6 |    INDEX UNIQUE SCAN         | SYS_C00377272 |     1 |       |     0   (0)| 00:00:01 |
|   7 |   TABLE ACCESS BY INDEX ROWID| PELICULAS     |     1 |   210 |     1   (0)| 00:00:01 |
----------------------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   4 - filter("A"."NOM"='Loy, Myrna')
   5 - access("A"."OID"="X"."ACTOR")
   6 - access("P"."OID"="X"."PELI")
 
Note
-----
   - SQL plan baseline "SQL_PLAN_4z5x6suxn6hpc21f1959c" used for this statement

CONSULTA 3: Las filas disminuyen de 9 a 1 y el coste disminuye de 80 a 70 
*/


/**********************************************************************************
*
*                                    EJERCICIO 3
*
**********************************************************************************/

exec dbms_stats.delete_table_stats(ownname => 'GIISGBD104', tabname => 'ACTORES');
exec dbms_stats.delete_table_stats(ownname => 'GIISGBD104', tabname => 'ACTUACION');
exec dbms_stats.delete_table_stats(ownname => 'GIISGBD104', tabname => 'PELICULAS');

--1. Obtenir per a cadascuna d'elles el seu pla d'execució.

//CONSULTA 1: 
EXPLAIN PLAN FOR
SELECT * FROM PELICULAS WHERE ANYO=1920;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));
    
/*
-------------------------------------------------------------------------------
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |           |    70 | 15960 |   102   (0)| 00:00:01 |
|*  1 |  TABLE ACCESS FULL| PELICULAS |    70 | 15960 |   102   (0)| 00:00:01 |
-------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter("ANYO"=1920)
 
Note
-----
   - dynamic statistics used: dynamic sampling (level=2)
*/

//CONSULTA 2:
EXPLAIN PLAN FOR
SELECT * FROM PELICULAS WHERE ANYO<1920;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));

/*
-------------------------------------------------------------------------------
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |           |   482 |   107K|   102   (0)| 00:00:01 |
|*  1 |  TABLE ACCESS FULL| PELICULAS |   482 |   107K|   102   (0)| 00:00:01 |
-------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter("ANYO"<1920)
 
Note
-----
   - dynamic statistics used: dynamic sampling (level=2)
*/

//CONSULTA 3
EXPLAIN PLAN FOR
SELECT * FROM PELICULAS WHERE ANYO>1920;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));

/*
-------------------------------------------------------------------------------
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |           | 11077 |  2466K|   102   (0)| 00:00:01 |
|*  1 |  TABLE ACCESS FULL| PELICULAS | 11077 |  2466K|   102   (0)| 00:00:01 |
-------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter("ANYO">1920)
 
Note
-----
   - dynamic statistics used: dynamic sampling (level=2)
*/

//CONSULTA 4
EXPLAIN PLAN FOR
SELECT * FROM PELICULAS WHERE ANYO<>1920;

SELECT plan_table_output
FROM 
    table(DBMS_XPLAN.DISPLAY('PLAN_TABLE',
    NULL,'TYPICAL'));

/*
-------------------------------------------------------------------------------
| Id  | Operation         | Name      | Rows  | Bytes | Cost (%CPU)| Time     |
-------------------------------------------------------------------------------
|   0 | SELECT STATEMENT  |           | 11558 |  2573K|   102   (0)| 00:00:01 |
|*  1 |  TABLE ACCESS FULL| PELICULAS | 11558 |  2573K|   102   (0)| 00:00:01 |
-------------------------------------------------------------------------------
 
Predicate Information (identified by operation id):
---------------------------------------------------
 
   1 - filter("ANYO"<>1920)
 
Note
-----
   - dynamic statistics used: dynamic sampling (level=2)
*/